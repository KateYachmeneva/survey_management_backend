{% extends 'base.html' %}
{% load static %}

{%  block header %}
    <link type="text/css" href="{% static 'css/table.css' %}" rel="stylesheet" />
{% endblock %}

{% block content %}
<center>
        <form action="" method="post" enctype="multipart/form-data" style="margin-top:0%">
            {% csrf_token %}
            <div style="max-width:500px">
                <a>Выберите рейс</a>
                    <p></p>
                     <div class="input-group mb-3">
                       <select type="text" name="run" class="form-select" id="run-select">
                           {% for r in context.run %}
                           {% if r == context.selected_run%}
                           <option value="{{r.id}}" selected>{{r}}</option>
                           {% else %}
                           <option value="{{r.id}}">{{r}}</option>
                           {% endif %}
                           {% endfor %}
                       </select>
                     </div>
            </div>
            <button type="submit" id='show-data' style="border:1">Показать данные</button>
            <button type="button" class="" placeholder="" data-toggle="modal" data-target="#data_Modal1">
                Добавить оси
            </button>
            <button type="button" class="" placeholder="" data-toggle="modal" data-target="#data_Modal2">
                Добавить скорректированные значения
            </button>

            <a  id="edit-redirect" href="{% url 'edit_axes' %}" style="text-decoration: none;color: #000;">
                <button type="button" style="border:1">Редактировать</button></a>

            <a  id="graph-redirect"  href="{% url 'graph_axes' %}" style="text-decoration: none;color: #000;">
                <button type="button" style="border:1">Графики контроля</button></a>
        </form>


    <hr style="color:#FFC501;margin-top:1%;border-width: 3px">

    <div class="container" style="max-width:500em">
        <div class="row">
            <div class="col-sm-4">
                <table  class="table table-light table-sm table-bordered table-hover"
                        name="table_axes">
                    <thead class="thead-dark">
                    <tr class="table" style="text-align: center;">
                        <th scope="col">Глубина</th>
                        <th scope="col">GX</th>
                        <th scope="col">GY</th>
                        <th scope="col">GZ</th>
                        <th scope="col">BX</th>
                        <th scope="col">BY</th>
                        <th scope="col">BZ</th>
                    </tr>
                    </thead>

                    <tbody>
                    {% for obj in context.data %}
                    <tr style="text-align: center;">
                        <td scope="col">{{obj.depth_dot}}</td>
                        <td scope="col">{{obj.CX_dot}}</td>
                        <td scope="col">{{obj.CY_dot}}</td>
                        <td scope="col">{{obj.CZ_dot}}</td>
                        <td scope="col">{{obj.BX_dot}}</td>
                        <td scope="col">{{obj.BY_dot}}</td>
                        <td scope="col">{{obj.BZ_dot}}</td>
                    </tr>
                    {% endfor %}
                    </tbody>
                </table>
            </div>

            <div class="col-sm-8">
                <table  class="table table-light table-sm table-bordered table-hover"
                        name="table_calculation">
                    <thead class="thead-dark">
                    <tr class="table" style="text-align: center;">
                        <th scope="col">Gtotal</th>
                        <th scope="col">Btotal_raw</th>
                        <th scope="col">Btotal_corr</th>
                        <th scope="col">DIP_raw</th>
                        <th scope="col">DIP_corr</th>
                        <th scope="col">Зенитный угол</th>
                        <th scope="col">{{context.selected_run.section.wellbore.well_name.get_north_direction}} азимут</th>
                        <th scope="col" style="width: 30%">Комментарий</th>
                    </tr>
                    </thead>

                    <tbody>
                    {% for obj in context.data %}
                    <tr style="text-align: center;">

                        {% if obj.Gtotal < context.well.min_gtotal or obj.Gtotal > context.well.max_gtotal %}
                        <td style="background-color:red" scope="col"> {{obj.Gtotal}} </td>
                        {% else %}
                        <td scope="col"> {{obj.Gtotal}} </td>
                        {% endif %}

                        {% if obj.Btotal < context.well.min_btotal or obj.Btotal > context.well.max_btotal %}
                        <td style="background-color:red" scope="col"> {{obj.Btotal}} </td>
                        {% else %}
                        <td scope="col"> {{obj.Btotal}} </td>
                        {% endif %}

                        {% if obj.Btotal_corrFix < context.well.min_btotal or obj.Btotal_corrFix > context.well.max_btotal %}
                        <td style="background-color:red" scope="col"> {{obj.Btotal_corrFix}}  </td>
                        {% else %}
                        <td scope="col"> {{obj.Btotal_corrFix}} </td>
                        {% endif %}

                        {% if obj.Dip < context.well.min_dip or obj.Dip > context.well.max_dip %}
                        <td style="background-color:red" scope="col"> {{obj.Dip}} </td>
                        {% else %}
                        <td scope="col"> {{obj.Dip}} </td>
                        {% endif %}

                        {% if obj.DIP_corrFix < context.well.min_dip or obj.DIP_corrFix > context.well.max_dip %}
                        <td style="background-color:red" scope="col"> {{obj.DIP_corrFix}} </td>
                        {% else %}
                        <td scope="col"> {{obj.DIP_corrFix}} </td>
                        {% endif %}

                        <td scope="col">{{obj.Zenit}}</td>
                        <td scope="col">{{obj.Azimut}}</td>
                        <td style="padding: 0em;">
                            <textarea style='width: 100%; height: 1em; Border: none; outline: none;' disabled>
                            </textarea>
                        </td>
                    </tr>
                    {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</center>




<!-- модальное окно для доабвления осей-->
<div class="modal fade" id="data_Modal1" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Добавление осей</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <form action=""  method="post" name="data_form" >
            <div class="modal-body">
                <div class="form-group">
                    <label for="modal-run1" class="col-form-label">Рейс:</label>
                    <select type="text" class="form-control" id="modal-run1" name="run"> </select>
                </div>
                <div class="form-group">
                    <label>Выберите телесистему</label>
                    <select type="text" name="device" class="form-select" id="device-select">
                        {% for element in context.telesystem %}
                        <option>{{element}}</option>
                        {% endfor %}
                        <option selected> ----- </option>
                    </select>
                </div>
                <div class="form-group col-md">
                    <a class="tooltip-test" title="Значения глубины и осей">
                        <label for="depth-text">Данные:</label></a>
                    <textarea class="form-control" id="depth-text" rows="20" name="data-axes"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="submit" class="btn btn-primary">Добавить</button>
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Закрыть</button>
            </div>
            </form>
        </div>
    </div>
</div>

<!-- модальное окно для доабвления скорректированных значений-->
<div class="modal fade" id="data_Modal2" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Добавление скорректированных значений</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <form action=""  method="post" name="data_form" >
            <div class="modal-body">
                    <div class="form-group">
                        <label for="modal-run2" class="col-form-label">Рейс:</label>
                        <select type="text" class="form-control" id="modal-run2" name="run"> </select>
                    </div>

                    <div class="form-group row">
                        <div class="form-group col-md-4">
                            <a class="tooltip-test" title="Вставьте значения глубины">
                            <label for="depth-text">Глубина:</label></a>
                            <textarea class="form-control"  rows="15" name="depth"></textarea>
                        </div>
                        <div class="form-group col-md-4">
                            <a class="tooltip-test" title="Вставьте значения Btotal_corr">
                            <label>Btotal_corr:</label></a>
                            <textarea class="form-control"  rows="15" name="Btotal_corr"></textarea>
                        </div>
                        <div class="form-group col-md-4">
                            <a class="tooltip-test" title="Вставьте значения DIP_corr">
                            <label>DIP_corr:</label></a>
                            <textarea class="form-control" rows="15" name="DIP_corr"></textarea>
                        </div>
                    </div>
            </div>
            <div class="modal-footer">
                <button type="submit" class="btn btn-primary">Добавить</button>
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Закрыть</button>
            </div>
            </form>
        </div>
    </div>
</div>


<script>

<!--Функция для модального окна 1 (Добавление осей)-->
$('#data_Modal1').on('show.bs.modal', function (event) {
  var button = $(event.relatedTarget) // Кнопка которая запускает модальное окно
  var recipient = button.data('whatever') // Извлечь информацию из data-* атрибутов
  var data = button.data('run')

  <!-- Копируем элементы из селектора на основной странице (рейс)-->
  parent_select= document.getElementById('run-select');
  Array.from(parent_select.options).forEach(function(element){
  opt = document.createElement("option");
  opt.value = element.value;
  opt.text = element.text;
  document.getElementById('modal-run1').add(opt);
  });
  document.getElementById('modal-run1').options[parent_select.selectedIndex].selected = true;

  <!-- Индекс телесистемы  -->
  var params = new FormData();
  params.set('run_title', sessionStorage.getItem("run_id"));

  console.log('http://'+window.location.hostname+':'+window.location.port+'/axes/run_index')
  fetch('http://'+window.location.hostname+':'+window.location.port+'/axes/run_index', {
       method: 'POST',
       body: params }).then(response=>response.json())
       .then(data=>{console.log(data);
                    document.getElementById("device-select").value=data.device;
                   })

})

<!--Функция для модального окна 2 (Добавление скорректированных значений)-->
$('#data_Modal2').on('show.bs.modal', function (event) {
  var button = $(event.relatedTarget) // Кнопка которая запускает модальное окно
  var recipient = button.data('whatever') // Извлечь информацию из data-* атрибутов
  var data = button.data('run')

  <!-- Копируем элементы из селектора на основной странице (рейс) -->
  parent_select= document.getElementById('run-select');
  Array.from(parent_select.options).forEach(function(element){
  opt = document.createElement("option");
  opt.value = element.value;
  opt.text = element.text;
  document.getElementById('modal-run2').add(opt);
  });
  document.getElementById('modal-run2').options[parent_select.selectedIndex].selected = true;

})


<!-- Загрузили страницу -->
window.addEventListener('load', () => {
    <!-- При загрузке открываем выбранную ранее скважину -->
    let run_id = sessionStorage.getItem("run_id");
    if (run_id != null) {
      Array.from(document.getElementById('run-select').options).forEach(function(element){
      if (element.value == run_id) {element.selected = true;}
      });
      {% if context.selected_run == 'None' %}
      document.getElementById('show-data').click();
      {% endif %}
    }

    {% if context.error_depth|length != 0 %}
      alert('Не удалось найти глубины: '+'{{context.error_depth}}');
    {% endif %}
});

<!--Записываем выбранный рейс и его скважину-->
document.getElementById('run-select').addEventListener('change', function () {
    let wellbores_list = {{context.wellbores_id}};
    let num_select = document.getElementById('run-select').selectedIndex;

    sessionStorage.setItem("wellbore_id", wellbores_list[num_select]);
    sessionStorage.setItem("run_id", document.getElementById('run-select').options[num_select].value);
});


</script>


{% endblock %}